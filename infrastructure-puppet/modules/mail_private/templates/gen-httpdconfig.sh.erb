#!/bin/bash

if [ "`/usr/bin/whoami`" != "root" ]; then
  echo "You must be root to run this script"
  exit 1;
fi

BASE=<%= @archives_www %>/mod_mbox/
PMCS_MACRO=/etc/apache2/sites-enabled/mail-private-pmcs.macro
COMMITTERS_MACRO=/etc/apache2/sites-enabled/mail-private-committers.macro

echo "Reading $BASE"
echo "Writing  PMCS_MACRO=$PMCS_MACRO and COMMITTERS_MACRO=$COMMITTERS_MACRO"

# grab all the hashes at once (ignore missing files here; it may be the first run)
SHA1_ORIGINAL="$(openssl dgst -sha1 $PMCS_MACRO $COMMITTERS_MACRO 2>/dev/null)"

echo "## Start the per PMC config for private-arch mail access" > ${PMCS_MACRO}
echo "## This file is automatically generated, any local changes will be lost on the next run" >> ${PMCS_MACRO}

echo "## Start the committers config for private-arch mail access" > ${COMMITTERS_MACRO}
echo "## This file is automatically generated, any local changes will be lost on the next run" >> ${COMMITTERS_MACRO}

# Get a list of all the valid projects/podlings - space separated including start and finish
LDAPLIST=" $(ldapsearch -x -LLL -b ou=project,ou=groups,dc=apache,dc=org cn=* cn | sed -n -e 's/cn: //p' | xargs) "

for DIR in `ls -1 ${BASE}`; do

  case $DIR in
    # Handle committer access first (the PMC - if any - is not relevant)
    # N.B. infrastructure@ was renamed to users@infra
    committers|committers-cvs|infrastructure|infra-users|jobs|site-cvs|site-dev|concom)
      echo "* ${DIR}... setting access to all ASF committers"

      cat <<EOT >>${COMMITTERS_MACRO}
Use MacroMboxCommitters "${DIR}"
EOT

      continue
      ;;
    incubator-*-private|incubator-*-security)
      FALLBACK='incubator'
      PMC=`echo ${DIR} | cut -f2 -d'-'`
      ;;
    *)
      FALLBACK=''
      PMC=`echo ${DIR} | cut -f1 -d'-'`
      ;;
  esac

  # This should agree with the list in update-pmc-dropdown.sh.erb
  case $PMC in
    hc)
      PMC=httpcomponents
      ;;
    empire) # hyphens are excluded above
      PMC=empire-db
      ;;
    community)
      PMC=comdev
      ;;
    travel)
      PMC=tac
      ;;
    whimsical)
      PMC=whimsy
      ;;
  esac
  echo "${DIR} : ${PMC}";

  if [[ $LDAPLIST == *" $PMC "* ]]; then
    LDAPCN=$PMC
  else
    LDAPCN=$FALLBACK
  fi

   if [ -n "${LDAPCN}" ]; then
    echo "* ${DIR}... has an LDAP CN - ${LDAPCN}";

    cat <<EOT >>${PMCS_MACRO}
Use MacroMboxPMC "${DIR}" "${PMC}" "${LDAPCN}"
EOT

  else
    echo "* ${DIR}... I can't seem to find an LDAP PMC group, so default the access to ASF Members only!";

    cat <<EOT >>${PMCS_MACRO}
# No need to specify member-only access as that is the default
# Use MacroMboxMembers "${DIR}"
EOT

  fi

done

# grab all the new hashes at once (don't ignore missing files)
SHA1_FINAL="$(openssl dgst -sha1 $PMCS_MACRO $COMMITTERS_MACRO)"

echo "Original hashes:"
echo "$SHA1_ORIGINAL"

echo "Final hashes:"
echo "$SHA1_FINAL"

if [ "$SHA1_FINAL" != "$SHA1_ORIGINAL" ]
then
    echo "Restarting httpd (graceful)"
    /usr/sbin/apache2 -k graceful
else
    echo "No change to generated files"
fi

echo "All done"
